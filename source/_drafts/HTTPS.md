---
title: HTTPS
tags:
---

超文本传输安全协议（英语：HyperText Transfer Protocol Secure，缩写：HTTPS；常称为HTTP over TLS、HTTP over SSL或HTTP Secure）是一种通过计算机网络进行安全通信的传输协议。HTTPS经由HTTP进行通信，但利用**SSL/TLS**来加密数据包。HTTPS开发的主要目的，是提供对网站服务器的身份认证，保护交换数据的隐私与完整性。

https://zh.wikipedia.org/wiki/%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93%E5%AE%89%E5%85%A8%E5%8D%8F%E8%AE%AE

## SSL/TLS优点

不使用SSL/TLS的HTTP通信，就是不加密的通信。所有信息明文传播，带来了三大风险。

（1） 窃听风险（eavesdropping）：第三方可以获知通信内容。
（2） 篡改风险（tampering）：第三方可以修改通信内容。
（3） 冒充风险（pretending）：第三方可以冒充他人身份参与通信。

SSL/TLS协议是为了解决这三大风险而设计的，希望达到：
（1） 所有信息都是加密传播，第三方无法窃听。
（2） 具有校验机制，一旦被篡改，通信双方会立刻发现。
（3） 配备身份证书，防止身份被冒充。

互联网是开放环境，通信双方都是未知身份，这为协议的设计带来了很大的难度。而且，协议还必须能够经受所有匪夷所思的攻击，这使得SSL/TLS协议变得异常复杂。

http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html

## SSL/TLS原理

SSL/TLS的基本思路是使用非对称加密，Server给Client公钥，Client用公钥加密信息，Server收到加密信息后用私钥解密。但是这个过程存在两个问题：
（1）如何保证公钥不被篡改
（2）公钥加密计算量太大
对于第一个问题，我们可以使用数字证书来保证(关于为什么能够保证将在后文讲解，这里先略过)
对于第二个问题，我们可以在Server与Client第一次通信中，生成一个用于对称加密的密钥(称为Session key)，然后使用非对称加密来加密这个密钥，在以后的通信中，使用对称加密对通信内容进行加密

总结一下，SSL/TLS协议的基本过程是这样的：
（1） 客户端向服务器端索要并验证公钥。
（2） 双方协商生成"对话密钥"。
（3） 双方采用"对话密钥"进行加密通信。
上面过程的前两步，又称为"握手阶段"（handshake）。

## SSL/TLS的握手步骤

### 1 客户端发出请求（ClientHello）
首先，客户端（通常是浏览器）先向服务器发出加密通信的请求，这被叫做ClientHello请求。
在这一步，客户端主要向服务器提供以下信息。
（1） 一个客户端生成的随机数（第一个随机数），稍后用于生成"对话密钥"。
（2） 支持的协议版本，比如TLS 1.0版。
（3） 支持的加密方法，比如RSA公钥加密。
（4） 支持的压缩方法。

### 2 服务器回应（SeverHello）

服务器收到客户端请求后，向客户端发出回应，这叫做SeverHello。服务器的回应包含以下内容。
（1） 一个服务器生成的随机数（第二个随机数），稍后用于生成"对话密钥"。
（2） 服务器证书。
（3） 确认使用的加密通信协议版本，比如TLS 1.0版本。如果浏览器与服务器支持的版本不一致，服务器关闭加密通信。
（4） 确认使用的加密方法，比如RSA公钥加密。

### 3 客户端回应

客户端收到服务器回应以后，首先验证服务器证书。如果证书不是可信机构颁布、或者证书中的域名与实际域名不一致、或者证书已经过期，就会向访问者显示一个警告，由其选择是否还要继续通信。

如果证书没有问题，客户端就会从证书中取出服务器的公钥。然后，向服务器发送下面三项信息。

（1） 一个随机数（第三个随机数）。该随机数用服务器公钥加密，防止被窃听。
（2） 编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。
（3） 客户端握手结束通知，表示客户端的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供服务器校验。

上面第一项的随机数，是整个握手阶段出现的第三个随机数，又称"pre-master key"。有了它以后，客户端和服务器就同时有了三个随机数，接着双方就用事先商定的加密方法，各自生成本次会话所用的同一把"会话密钥"。

### 4 服务器的最后回应

服务器收到客户端的第三个随机数pre-master key之后，计算生成本次会话所用的"会话密钥"。然后，向客户端最后发送下面信息。

（1）编码改变通知，表示随后的信息都将用双方商定的加密方法和密钥发送。

（2）服务器握手结束通知，表示服务器的握手阶段已经结束。这一项同时也是前面发送的所有内容的hash值，用来供客户端校验。

至此，整个握手阶段全部结束。接下来，客户端与服务器进入加密通信，对于HTTPS来说就完全是使用普通的HTTP协议，只不过用"会话密钥"加密内容。

## 数字证书

上文提到了，为了保证服务器公钥不被篡改，要使用证书来包装，那么证书是如何保证公钥不会篡改的呢？

### 数字证书的生成过程

要解释这个问题，我们先要了解数字证书的生成过程

（1）服务器向第三方机构（甚至可以是自己）提交公钥，组织信息，个人信息等信息申请认证，一般打包为一个CSR文件，

（2）第三方机构对申请者提交的信息进行审核，审核通过后通过，会对服务器发放数字证书。
证书包含以下信息：**申请者公钥**、申请者的组织信息和个人信息、签发机构 CA 的信息、有效时间、证书序列号等**信息的明文**，同时包含一个**签名**；
签名的产生算法：首先，使用散列函数计算公开的明文信息的信息摘要，然后，采用 CA 的私钥对信息摘要进行加密，密文即签名；

下图表示了数字签名的组成部分

### 验证数字证书

当客户端收到服务器发来的证书后，由于证书中包含了服务器的公钥，为了保证服务器公钥是正确的，需要验证收到的数字证书。
客户端读取证书中的相关的明文信息，采用相同的hash函数计算得到信息摘要，然后，利用对应 CA 的公钥解密签名数据，对比证书的信息摘要，如果一致，则可以确认证书的合法性，即公钥合法；

### CA证书

上面提到了，证书是由第三方机构生成的，但是并不是所有的第三方机构都是被信任的（例如使用的是自签名的证书的话使用chrome访问会报错），所以就需要有一个权威机构来颁发证书，这个机构就叫Certificate Authority（CA），由CA颁发的证书就叫CA证书。